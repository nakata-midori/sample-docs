name: Create site directory and PR

# æ³¨æ„: ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å‹•ä½œã•ã›ã‚‹ã«ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã§
# Settings > Actions > General > "Allow GitHub Actions to create and approve pull requests" 
# ã‚’æœ‰åŠ¹ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

on:
  push:
    branches: ['main', 'feature/**']

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate site directory
        run: node scripts/generate-site-directory.ts

      - name: Commit site directory
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add static/site-directory.json
          git commit -m 'chore: update site directory [skip ci]' || echo "No changes"
          git push

      - name: Get branch info
        id: branch
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          FEATURE_NAME=${BRANCH_NAME#feature/}
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "feature_name=$FEATURE_NAME" >> $GITHUB_OUTPUT

      - name: Get commit info
        id: commit
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

      - name: Check if PR exists
        id: check-pr
        run: |
          PR_NUMBER=$(gh pr list --head ${{ steps.branch.outputs.branch_name }} --base main --json number --jq '.[0].number // empty')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_number == ''
        run: |
          gh pr create \
            --title "feat: ${{ steps.branch.outputs.feature_name }} æ©Ÿèƒ½é–‹ç™º" \
            --body "$(cat <<'EOF'
          ## ðŸš€ æ©Ÿèƒ½é–‹ç™ºPR

          **ãƒ–ãƒ©ãƒ³ãƒ**: \`${{ steps.branch.outputs.branch_name }}\`  
          **æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ**: ${{ steps.commit.outputs.sha }}

          ### ðŸ“ æœ€æ–°ã®å¤‰æ›´
          \`\`\`
          ${{ steps.commit.outputs.message }}
          \`\`\`

          ### âœ… é–‹ç™ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          - [ ] æ©Ÿèƒ½è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹
          - [ ] ãƒ†ã‚¹ãƒˆãŒè¿½åŠ ãƒ»æ›´æ–°ã•ã‚Œã¦ã„ã‚‹
          - [ ] docs/development.md ã®ãƒ«ãƒ¼ãƒ«ã«æº–æ‹ ã—ã¦ã„ã‚‹
          - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹
          - [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã«å•é¡ŒãŒãªã„

          ### ðŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          - [é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](./docs/development.md)
          - [ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰](./CONTRIBUTING.md)

          ---
          ðŸ¤– ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ

          ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
          EOF
          )" \
            --base main \
            --head ${{ steps.branch.outputs.branch_name }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing PR
        if: steps.check-pr.outputs.pr_number != ''
        run: |
          gh pr edit ${{ steps.check-pr.outputs.pr_number }} \
            --body "$(cat <<'EOF'
          ## ðŸš€ æ©Ÿèƒ½é–‹ç™ºPR (æ›´æ–°æ¸ˆã¿)

          **ãƒ–ãƒ©ãƒ³ãƒ**: \`${{ steps.branch.outputs.branch_name }}\`  
          **æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ**: ${{ steps.commit.outputs.sha }}

          ### ðŸ“ æœ€æ–°ã®å¤‰æ›´
          \`\`\`
          ${{ steps.commit.outputs.message }}
          \`\`\`

          ### âœ… é–‹ç™ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          - [ ] æ©Ÿèƒ½è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹
          - [ ] ãƒ†ã‚¹ãƒˆãŒè¿½åŠ ãƒ»æ›´æ–°ã•ã‚Œã¦ã„ã‚‹
          - [ ] docs/development.md ã®ãƒ«ãƒ¼ãƒ«ã«æº–æ‹ ã—ã¦ã„ã‚‹
          - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹
          - [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã«å•é¡ŒãŒãªã„

          ### ðŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          - [é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](./docs/development.md)
          - [ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰](./CONTRIBUTING.md)

          ---
          ðŸ¤– ã“ã®PRã¯è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã—ãŸ

          ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
          EOF
          )"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}